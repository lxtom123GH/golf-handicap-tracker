rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    function isApproved() {
      let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
      return exists(userPath) && (
        get(userPath).data.get('isApproved', true) == true || 
        get(userPath).data.get('isAdmin', false) == true
      );
    }
    
    function isAdmin() {
      let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
      return exists(userPath) && get(userPath).data.get('isAdmin', false) == true;
    }
    
    function isCoachOf(studentId) {
      let userPath = /databases/$(database)/documents/users/$(studentId);
      return exists(userPath) && request.auth.uid in get(userPath).data.get('coaches', []);
    }

    // Schema Validation Helpers
    function isValidString(val, minLen, maxLen) {
      return val is string && val.size() >= minLen && val.size() <= maxLen;
    }
    function isValidNumber(val, minVal, maxVal) {
      return (val is int || val is float) && val >= minVal && val <= maxVal;
    }
    function hasFields(data, fields) {
      return data.keys().hasAll(fields);
    }

    // Users Collection
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId && 
                    hasFields(request.resource.data, ['email', 'isAdmin']) &&
                    request.resource.data.isAdmin == false &&
                    (
                      request.resource.data.get('isApproved', false) == false ||
                      exists(/databases/$(database)/documents/preapproved_emails/$(request.resource.data.email))
                    );
      allow update: if request.auth != null && (
        isAdmin() || 
        (request.auth.uid == userId && 
         request.resource.data.get('isApproved', false) == resource.data.get('isApproved', false) &&
         request.resource.data.get('isAdmin', false) == resource.data.get('isAdmin', false))
      );
      
      // Settings / Prefs Subcollection
      match /prefs/{prefId} {
        allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      }
      
      // Social Following Subcollection
      match /following/{targetUid} {
        allow read: if request.auth != null && isApproved();
        allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      }
      
      // Coach Notes Subcollection
      match /coachNotes/{noteId} {
        allow read: if request.auth != null && isApproved() && (request.auth.uid == userId || isCoachOf(userId) || isAdmin());
        allow write: if request.auth != null && isApproved() && (isCoachOf(userId) || isAdmin()) &&
                     hasFields(request.resource.data, ['coachUid', 'text', 'createdAt']);
      }
      
      // Coach Assigned Drills Subcollection
      match /assignedDrills/{drillId} {
        allow read: if request.auth != null && isApproved() && (request.auth.uid == userId || isCoachOf(userId) || isAdmin());
        allow write: if request.auth != null && isApproved() && (isCoachOf(userId) || isAdmin()) &&
                     hasFields(request.resource.data, ['drillName', 'assignedBy', 'assignedAt']);
      }
    }
    
    // Profiles Collection (Handicap array)
    match /profiles/{userId} {
      allow read: if request.auth != null && isApproved();
      allow write: if request.auth != null && isApproved() && request.auth.uid == userId &&
                   hasFields(request.resource.data, ['handicapHistory']);
    }
    
    // WHS Rounds Collection
    match /whs_rounds/{roundId} {
      allow read, list: if request.auth != null && isApproved();
      allow create: if request.auth != null && isApproved() && 
                    request.resource.data.uid == request.auth.uid &&
                    hasFields(request.resource.data, ['course', 'adjustedGross', 'rating', 'slope', 'date']) &&
                    isValidString(request.resource.data.course, 1, 100) &&
                    isValidNumber(request.resource.data.adjustedGross, 20, 200) &&
                    isValidNumber(request.resource.data.rating, 30, 90) &&
                    isValidNumber(request.resource.data.slope, 50, 155);
      allow update, delete: if request.auth != null && isApproved() && resource.data.uid == request.auth.uid;
    }

    // Competitions Collection
    match /competitions/{compId} {
      allow read, list: if request.auth != null && isApproved() && (
        resource.data.get('visibility', 'public') == 'public' ||
        resource.data.ownerId == request.auth.uid ||
        request.auth.uid in resource.data.get('invitedUIDs', []) ||
        isAdmin()
      );
      allow create: if request.auth != null && isApproved() && 
                    hasFields(request.resource.data, ['name', 'ownerId', 'rules']) &&
                    request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if request.auth != null && isApproved() && (resource.data.ownerId == request.auth.uid || isAdmin());
    }
    
    // Competition Rounds Collection
    match /comp_rounds/{compRoundId} {
      allow read, list: if request.auth != null && isApproved();
      allow create: if request.auth != null && isApproved() && 
                    hasFields(request.resource.data, ['compId', 'uid', 'score']) &&
                    request.resource.data.uid == request.auth.uid;
      allow delete: if request.auth != null && isApproved() && resource.data.uid == request.auth.uid;
    }

    // Practice Rounds Collection
    match /practice_rounds/{practiceId} {
      allow read, list: if request.auth != null && isApproved() && resource.data.uid == request.auth.uid;
      allow create: if request.auth != null && isApproved() && 
                    request.resource.data.uid == request.auth.uid &&
                    hasFields(request.resource.data, ['drillName', 'score', 'date']) &&
                    isValidString(request.resource.data.drillName, 1, 100);
      allow delete: if request.auth != null && isApproved() && resource.data.uid == request.auth.uid;
    }

    // Pre-Approved Emails Collection
    match /preapproved_emails/{emailId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isAdmin();
    }

    // Shot Tracker Collection
    match /shots/{shotId} {
      allow read, list: if request.auth != null && isApproved() && resource.data.uid == request.auth.uid;
      allow create: if request.auth != null && isApproved() && 
                    request.resource.data.uid == request.auth.uid &&
                    hasFields(request.resource.data, ['hole', 'club']) &&
                    isValidNumber(request.resource.data.hole, 1, 18);
      allow update, delete: if request.auth != null && isApproved() && resource.data.uid == request.auth.uid;
    }
  }
}
